version: '3'

includes:
  s3: ./s3.taskfile.yml
  gcs: ./gcs.taskfile.yml

dotenv:
  - /workspace/storage-env-files/{{ .ENV_FILE }}

tasks:
  _upload:
    internal: true
    dotenv:
      - /workspace/storage-env-files/{{ .ENV_FILE }}
    cmds:
      - task: "{{ .STORAGE_TYPE }}:init"
        vars:
          ENV_FILE: '{{ .ENV_FILE }}'
      - task: "{{ .STORAGE_TYPE }}:upload"
        vars:
          ENV_FILE: '{{ .ENV_FILE }}'
      - task: "{{ .STORAGE_TYPE }}:clean"
        vars:
          ENV_FILE: '{{ .ENV_FILE }}'
  
  _skip:
    internal: true

  _nodata:
    internal: true
    cmds:
      - |
        >&2 echo -e "\033[1;33mWARN\033[0;93m - No data to upload in '{{ .BACKUP_DIR }}'. Skipping upload.\033[m"

  upload:
    requires:
      vars:
        - ENV_FILE
        - name: STORAGE_TYPE
          enum: ['s3', 'gcs']
    vars:
      IGNORE: '{{ .IGNORE | default "false" }}'
      NO_DATA: 
        sh: |
          if [ -z "$(find {{ .BACKUP_DIR }}  -type f)" ]; then
            echo "true"
          else
            echo "false"
          fi
    preconditions:
      - sh: |
          [ "{{ .IGNORE }}" == "true" ] || [ "{{ .IGNORE }}" == "false" ]
        msg: "IGNORE must be 'true' or 'false'. Got '{{ .IGNORE }}'."
    cmds:
      - task: '{{ if eq .IGNORE "true" }}_skip{{ else if eq .NO_DATA "true" }}_nodata{{ else }}_upload{{ end }}'