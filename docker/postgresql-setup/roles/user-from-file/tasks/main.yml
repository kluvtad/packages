- name: "Load user configuration from file {{ user_file }}"
  set_fact:
    user_config: "{{ lookup('ansible.builtin.file', user_file) | from_yaml }}"

- name: "Extract username from file path"
  set_fact:
    username: "{{ user_file | basename | regex_replace('\\.yml$', '') }}"

- name: "Set valid keys for user configuration"
  set_fact:
    valid_keys:
      - comment
      - configuration
      - conn_limit
      - expires
      - role_attr_flags

- name: "Validate {{ username }}'s user_config keys"
  set_fact:
    invalid_keys: "{{ user_config | list | difference(valid_keys) }}"

- name: "{{ username }} - Fail if invalid keys are found"
  fail:
    msg: "Invalid keys found in {{ username }}: {{ invalid_keys | join(', ') }}. Valid keys are: {{ valid_keys | join(', ') }}"
  when: invalid_keys | length > 0